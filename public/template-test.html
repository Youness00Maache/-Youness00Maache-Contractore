<!DOCTYPE html>
<html>

<head>
    <title>Template Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
    <h1>Template Background Test</h1>
    <button onclick="testPDF()">Generate Test PDF</button>

    <script>
        const { jsPDF } = window.jspdf;

        async function loadImage(url) {
            try {
                console.log('Loading image from:', url);
                const response = await fetch(url);
                const blob = await response.blob();
                const dataUrl = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });

                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        let format = 'PNG';
                        if (dataUrl.startsWith('data:image/jpeg')) format = 'JPEG';
                        console.log('Image loaded successfully:', img.naturalWidth, 'x', img.naturalHeight);
                        resolve({ data: dataUrl, format: format, width: img.naturalWidth, height: img.naturalHeight });
                    };
                    img.onerror = () => {
                        console.error('Image failed to load');
                        resolve(null);
                    };
                    img.src = dataUrl;
                });
            } catch (e) {
                console.error('loadImage failed:', e);
                return null;
            }
        }

        async function testPDF() {
            console.log('Creating PDF...');
            const doc = new jsPDF();

            const bg = await loadImage('/templates/1.jpg');
            if (bg) {
                console.log('Adding background to PDF');
                doc.addImage(bg.data, bg.format, 0, 0, 210, 297);
            } else {
                console.error('Background image failed to load');
                doc.setTextColor(255, 0, 0);
                doc.setFontSize(12);
                doc.text('Error: Could not load background image', 10, 10);
            }

            // Add some text on top
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(16);
            doc.text('Test Invoice', 105, 30, { align: 'center' });

            doc.save('test.pdf');
            console.log('PDF saved');
        }
    </script>
</body>

</html>